<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Churn Risk Predictor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .explanation-container {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .explanation-title {
            margin-bottom: 10px;
            color: #333;
        }
        .shap-container {
            margin-top: 20px;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .shap-plot {
            width: 100%;
            overflow-x: auto;
        }
        .results h3 span.high {
            color: red;
        }
        .results h3 span.medium {
            color: orange;
        }
        .results h3 span.low {
            color: green;
        }
    </style>
</head>
<body>
    <div class="container">
        <h2>Customer Churn Prediction</h2>

        <form method="post" action="/predict">
            <!-- Looping through all input fields -->
            <div class="form-group">
                <label for="Contract">Contract Type</label>
                <select name="Contract" required>
                    <option value="">Select Contract Type</option>
                    <option>Month-to-month</option>
                    <option>One year</option>
                    <option>Two year</option>
                </select>
            </div>

            <div class="form-group">
                <label for="tenure">Tenure (months)</label>
                <input type="number" name="tenure" min="0" max="120" required>
            </div>

            <div class="form-group">
                <label for="TechSupport">Tech Support</label>
                <select name="TechSupport" required>
                    <option value="">Select Tech Support</option>
                    <option>No</option>
                    <option>Yes</option>
                    <option>No internet service</option>
                </select>
            </div>

            <div class="form-group">
                <label for="OnlineSecurity">Online Security</label>
                <select name="OnlineSecurity" required>
                    <option value="">Select Online Security</option>
                    <option>No</option>
                    <option>Yes</option>
                    <option>No internet service</option>
                </select>
            </div>

            <div class="form-group">
                <label for="InternetService">Internet Service</label>
                <select name="InternetService" required>
                    <option value="">Select Internet Service</option>
                    <option>Fiber optic</option>
                    <option>DSL</option>
                    <option>No</option>
                </select>
            </div>

            <div class="form-group">
                <label for="MonthlyCharges">Monthly Charges (RS)</label>
                <input type="number" name="MonthlyCharges" min="0" step="0.01" required>
            </div>

            <div class="form-group">
                <label for="TotalCharges">Total Charges (RS)</label>
                <input type="number" name="TotalCharges" min="0" step="0.01" required>
            </div>

            <div class="form-group">
                <label for="PaymentMethod">Payment Method</label>
                <select name="PaymentMethod" required>
                    <option value="">Select Payment Method</option>
                    <option>Electronic check</option>
                    <option>Mailed check</option>
                    <option>Bank transfer (automatic)</option>
                    <option>Credit card (automatic)</option>
                </select>
            </div>

            <div class="form-group">
                <label for="DeviceProtection">Device Protection</label>
                <select name="DeviceProtection" required>
                    <option value="">Select Device Protection</option>
                    <option>No</option>
                    <option>Yes</option>
                    <option>No internet service</option>
                </select>
            </div>

            <div class="form-group">
                <label for="OnlineBackup">Online Backup</label>
                <select name="OnlineBackup" required>
                    <option value="">Select Online Backup</option>
                    <option>No</option>
                    <option>Yes</option>
                    <option>No internet service</option>
                </select>
            </div>

            <div class="form-group">
                <label for="StreamingMovies">Streaming Movies</label>
                <select name="StreamingMovies" required>
                    <option value="">Select Streaming Movies</option>
                    <option>No</option>
                    <option>Yes</option>
                    <option>No internet service</option>
                </select>
            </div>

            <div class="form-group">
                <label for="StreamingTV">Streaming TV</label>
                <select name="StreamingTV" required>
                    <option value="">Select Streaming TV</option>
                    <option>No</option>
                    <option>Yes</option>
                    <option>No internet service</option>
                </select>
            </div>

            <input type="submit" value="Predict Risk Score">
        </form>

        {% if risk_score is defined %}
        <div class="results">
            <h3>Risk Score: {{ risk_score }}%</h3>
            <h3>Model-Based Risk Category: <span class="{{ risk_category|lower }}">{{ risk_category }}</span></h3>

            {% if retention_actions %}
            <h3>Retention Actions:</h3>
            <ul>
                {% for action in retention_actions %}
                <li class="{{ risk_category|lower }}">{{ action }}</li>
                {% endfor %}
            </ul>
            {% endif %}

            {% if rule_based_category %}
            <h3>Rule-Based Risk Category: <span class="{{ rule_based_category|lower }}">{{ rule_based_category }}</span></h3>
            {% endif %}
        </div>

        <div class="explanation-container">
            <h3 class="explanation-title">LIME Explanation (Local Interpretable Model-agnostic Explanations)</h3>
            <div style="max-height: 400px; overflow-y: auto;">
                {{ lime_html | safe }}
            </div>
        </div>

        <div class="shap-container">
            <h3 class="explanation-title">SHAP Explanation (SHapley Additive exPlanations)</h3>
            <div class="shap-plot">
                {% if shap_plot %}
                    <iframe src="{{ shap_plot }}" width="100%" height="400" style="border:none;"></iframe>
                {% else %}
                    <p>SHAP explanation could not be generated.</p>
                {% endif %}
            </div>
            <p style="margin-top: 10px; font-size: 0.9em; color: #666;">
                SHAP values show how each feature contributes to the prediction.
                Features in red increase the risk of churn, while features in blue decrease it.
                The base value is the average prediction.
            </p>
        </div>
        {% endif %}
    </div>
</body>
</html>
